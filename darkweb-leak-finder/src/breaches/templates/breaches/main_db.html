{% extends "core/base.html" %}
{% block content %}

<!-- flash messages -->
{% if messages %}
  <div class="mb-3">
    {% for m in messages %}
      <div class="alert alert-{{ m.tags|default:"secondary" }} mb-2">{{ m }}</div>
    {% endfor %}
  </div>
{% endif %}

<section id="identities" class="mb-4">
  <div class="card p-3 shadow-sm">
    <h2 class="h5 mb-3">Email Data Breach Check</h2>
    <form method="post" action="{% url 'breaches:add' %}" class="d-flex gap-2 mb-3">
      {% csrf_token %}
      <input name="email" type="email" class="form-control" placeholder="email@example.com" required>
      <button class="btn btn-primary">Add</button>
    </form>

    {% if identities %}
      <ul class="list-group list-group-flush">
        {% for i in identities %}
          <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center">
            {# FIX 1: link to detail page #}
            <a href="{% url 'breaches:identity_detail' i.pk %}" class="text-decoration-none">
              {{ i.address }}
            </a>

            {# FIX 2 (optional): prefer explicit name over legacy alias #}
            <a href="{% url 'breaches:scan_identity' pk=i.pk %}" class="btn btn-sm btn-outline-light">Scan</a>
            {# if you want to keep the alias, your existing {% url 'breaches:scan' i.pk %} still works #}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <span class="text-muted small">No identities yet. Add one above.</span>
    {% endif %}
  </div>
</section>

<section id="scan" class="mt-4">
  <div class="card p-3 shadow-sm">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h2 class="h5 mb-0">Domain or IP Port Scan</h2>
      <small class="text-muted">Enter a domain or IP</small>
    </div>

    <form method="post" action="{% url 'breaches:scan_target' %}" class="d-flex gap-2">
      {% csrf_token %}
      <input name="target" type="text" class="form-control" placeholder="example.com or 1.2.3.4" required>
      <button class="btn btn-primary">Scan</button>
    </form>
  <!--</div>-->

  {% if scans %}
    <!--<div class="card p-3 shadow-sm mt-3">-->
      <h3 class="h6 mb-2 pt-2">Recent scans</h3>
      <ul class="list-group list-group-flush" id="recent-scans">
        {% for s in scans %}
          <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center">
            <span>
              <strong>{{ s.ip }}</strong><br>

              {% if s.hostnames and s.hostnames|length %}
                <span class="small text-muted">Hostnames:</span> {{ s.hostnames|join:", " }}<br>
              {% endif %}

              {% if s.org %}
                <span class="small text-muted">Organization:</span> {{ s.org }}<br>
              {% endif %}

              {% if s.os %}
                <span class="small text-muted">OS:</span> {{ s.os }}<br>
              {% endif %}

              {% if s.ports and s.ports|length %}
                <span class="small text-muted">Ports:</span> {{ s.ports|join:", " }}<br>
              {% endif %}

              <span class="small text-muted">Scan Time:</span> {{ s.last_seen|date:"Y-m-d H:i" }}
            </span>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
</section>

{% endblock %}