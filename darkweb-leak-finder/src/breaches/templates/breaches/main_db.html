{% extends "core/base.html" %}
{% block content %}
{% load static %}

<!-- =======================
     NEW FULL-WIDTH SECTION
     ======================= -->
<section id="attack-summary" class="mb-4">
  <div class="attack-summary-bar d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div class="d-flex flex-wrap align-items-center gap-2">
      <strong>ShadowScan: </strong>
      <span class="text-muted small">
        Email breach checks, exposed services, and live attack hotspots.
      </span>
    </div>
    <div class="d-flex align-items-center gap-3">
      <a href="#"
         class="small text-decoration-none"
         style="color:#93c5fd;"
         data-bs-toggle="modal"
         data-bs-target="#aboutThreatDashboardModal">
        About this tool
      </a>
    </div>
  </div>
</section>

<div class="row g-4 align-items-start">
  <!-- LEFT: cards -->
  <div class="col-12 col-lg-5 col-xl-4" id="left-col">
    <!-- Email Data Breach Check -->
    <section id="identities" class="mb-4">
      <div class="card p-3 shadow-sm">
        <h2 class="h5 mb-3">Email Data Breach Check</h2>
        <form method="post" action="{% url 'breaches:add' %}" class="d-flex gap-2 mb-3">
          {% csrf_token %}
          <input name="email" type="email" class="form-control" placeholder="email@example.com" required>
          <button class="btn btn-primary">Add</button>
        </form>

        {% if identities %}
          <ul class="list-group list-group-flush">
            {% for i in identities %}
              <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center">
                <a href="{% url 'breaches:identity_detail' i.pk %}" class="text-decoration-none">
                  {{ i.address }}
                </a>

                <div class="d-flex gap-2">
                  {# POST Scan with loading state #}
                  <form method="post"
                        action="{% url 'breaches:scan_identity' pk=i.pk %}"
                        class="m-0"
                        onsubmit="const b=this.querySelector('button'); if(b){b.disabled=true; b.textContent='Scanning…';}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-light">Scan</button>
                  </form>

                  {# POST Remove with confirm #}
                  <form method="post"
                        action="{% url 'breaches:delete_identity' pk=i.pk %}"
                        class="m-0"
                        onsubmit="return confirm('Remove {{ i.address }}? This will also delete its saved breach results.');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
                  </form>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <span class="text-muted small">No identities yet. Add one above.</span>
        {% endif %}
      </div>
    </section>

    <!-- Domain/IP Port Scan -->
    <section id="scan" class="mt-4">
      <div class="card p-3 shadow-sm">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h5 mb-0">Domain or IP Port Scan</h2>
          <small class="text-muted">Enter a domain or IP</small>
        </div>

        <form method="post" action="{% url 'breaches:scan_target' %}" class="d-flex gap-2">
          {% csrf_token %}
          <input name="target" type="text" class="form-control" placeholder="example.com or 1.2.3.4" required>
          <button class="btn btn-primary">Scan</button>
        </form>

        {% if scans %}
          <h3 class="h6 mb-2 pt-2">Recent scans</h3>
          <ul class="list-group list-group-flush" id="recent-scans">
            {% for s in scans %}
              <li class="list-group-item bg-transparent">
                <div class="d-flex justify-content-between align-items-start gap-2">
                  <span>
                    <strong>{{ s.ip }}</strong><br>
                    {% if s.hostnames and s.hostnames|length %}
                      <span class="small text-muted">Hostnames:</span> {{ s.hostnames|join:", " }}<br>
                    {% endif %}
                    {% if s.org %}
                      <span class="small text-muted">Organization:</span> {{ s.org }}<br>
                    {% endif %}
                    {% if s.os %}
                      <span class="small text-muted">OS:</span> {{ s.os }}<br>
                    {% endif %}
                    {% if s.ports and s.ports|length %}
                      <span class="small text-muted">Open Ports:</span> {{ s.ports|join:", " }}<br>
                    {% endif %}
                    <span class="small text-muted">Scan Time:</span> {{ s.last_seen|date:"Y-m-d H:i" }}
                  </span>

                  <div class="d-flex gap-2">
                    {# Quick rescan (pre-fills target with this IP) #}
                    <form method="post" action="{% url 'breaches:scan_target' %}" class="m-0"
                          onsubmit="const b=this.querySelector('button'); if(b){b.disabled=true; b.textContent='Scanning…';}">
                      {% csrf_token %}
                      <input type="hidden" name="target" value="{{ s.ip }}">
                      <button class="btn btn-sm btn-outline-light" type="submit">Rescan</button>
                    </form>

                    {# Remove this saved scan #}
                    <form method="post" action="{% url 'breaches:delete_scan' pk=s.pk %}" class="m-0"
                          onsubmit="return confirm('Remove saved Shodan scan for {{ s.ip }}?');">
                      {% csrf_token %}
                      <button class="btn btn-sm btn-outline-danger" type="submit">Remove</button>
                    </form>
                  </div>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    </section>
  </div>

  {# RIGHT: heat map + sidebar #}
  <div class="col-12 col-lg-7 col-xl-8">
    <div class="card p-0 shadow-sm" style="min-height:60vh;">
      <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <h2 class="h5 mb-0">Global Attack Heat Map</h2>
          <!-- Source selector -->
          <select id="tm-radar-source" class="form-select form-select-sm ms-2" style="width:auto;">
            <option value="layer7_origin" selected>Application Attack Point of Origin</option>
            <option value="layer7_target">Application Attack Target</option>
            <option value="layer3_origin">Network Attack Point of Origin</option>
            <option value="layer3_target">Network Attack Target</option>
          </select>
        </div>
        <small class="text-muted" id="tm-meta"></small>
      </div>

      <div class="row g-0">
        <!-- MAP -->
        <div class="col-12 col-xl-9">
          <div id="tm-world-map" class="tm-map"></div>
        </div>

        <!-- SIDEBAR -->
        <div class="col-12 col-xl-3 border-top border-xl-start border-secondary-subtle">
          <div class="p-3 tm-sidebar" id="tm-sidebar">
            <h3 class="h6 text-uppercase mb-3 text-muted">Attack Snapshot</h3>

            <div class="mb-3">
              <h4 class="h6 mb-1">Top Countries</h4>
              <p class="small text-muted mb-2">
                Percentage of all attack activity in last 24h
              </p>
              <ol class="list-unstyled small mb-0" id="tm-top-countries">
                <!-- filled by JS -->
              </ol>
                <div class="card p-3 shadow-sm mt-3" style="background:#0f141a; border:1px solid #1f2a33;">
                  <h2 class="h6 mb-2" style="color:#fff;">Network & Application Attacks</h2>
                  <p style="color:#c7d0da; font-size:0.9rem;">
                    This dashboard visualizes hostile traffic detected across the internet.
                    <strong>Network-layer attacks</strong> include scanning, port probing, and DDoS events
                    targeting infrastructure.
                    <strong>Application-layer attacks</strong> represent malicious HTTP requests such as
                    credential stuffing, API abuse, and web application exploitation attempts.
                    Together, these signals provide visibility into global threat activity.
                  </p>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{# put these once per page (base template is fine) #}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="{% static 'threatmap/js/heatmap.js' %}?v=5"></script>

<!-- Optional: keep the left column visible while scrolling the map -->
<style>
  @media (min-width: 992px) { /* lg and up */
    #left-col { position: sticky; top: 1rem; align-self: flex-start; }
  }

  /* Threat map + sidebar */
  .tm-map {
    height: calc(100vh - 220px);
    min-height: 360px;
    background: #0f141a;
  }

  .tm-sidebar {
    background: #0b1016;
    height: 100%;
  }

  @media (min-width: 1200px) {
    .tm-sidebar {
      max-height: calc(100vh - 220px);
      overflow-y: auto;
    }
  }

  #tm-top-countries li {
    padding: 0.15rem 0;
  }

  #tm-top-countries li span:last-child {
    font-variant-numeric: tabular-nums;
  }

  /* Make the main content band wider on large screens */
  @media (min-width: 1200px) {
    .container {
      max-width: 1700px;  /* ~15–20% wider than default */
    }
  }

  /* dark_web.css or similar */
  .attack-summary-bar {
      background:#0f141a;
      border:1px solid #1f2a33;
      padding:1.1rem 1.5rem;  /* controls height */
      min-height:64px;
      border-radius:0.5rem;
  }
</style>

<div class="modal fade" id="aboutThreatDashboardModal" tabindex="-1"
     aria-labelledby="aboutThreatDashboardLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark border border-secondary">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="aboutThreatDashboardLabel">
          About Dark Web Leak Finder &amp; ThreatMap
        </h5>
        <button type="button" class="btn-close btn-close-white"
                data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-muted">
        <p class="mb-3">
          This dashboard is a proof-of-concept security analytics tool built for
          graduate coursework in cybersecurity. It combines several data sources
          to give a high-level view of identity exposure and global attack activity.
        </p>
        <ul class="mb-3">
          <li>
            <strong>Email Data Breach Check</strong> – looks up email addresses
            against known breach data via public breach APIs (for example, Have I
            Been Pwned) to highlight where identities may already be exposed.
          </li>
          <li>
            <strong>Domain or IP Port Scan</strong> – summarizes recent Shodan-style
            scan results so you can see internet-facing services and potential weak points.
          </li>
          <li>
            <strong>Global Attack Heat Map</strong> – visualizes network-layer and
            application-layer attack activity (such as DDoS, scanning, credential
            stuffing, and web exploit attempts) by point of origin or target.
          </li>
        </ul>
        <p class="small mb-0">
          This tool is for educational and defensive security research only. It does
          not perform offensive actions and should not be used to attack systems or services.
        </p>
      </div>
    </div>
  </div>
</div>


{% endblock %}
