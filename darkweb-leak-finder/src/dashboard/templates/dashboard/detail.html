{# src/dashboard/templates/dashboard/detail.html #}
{% extends "core/base.html" %}
{% load humanize %}

{% block title %}{{ identity.address }} · Dark Web Leak Finder{% endblock %}

{% block content %}

  {% comment %}
    Identity detail card
    --------------------
    Shows a single email identity with all known breach hits.

    OWASP Top 10 touchpoints:
      - A01/A07: Access control & auth
          * This view should be protected by login_required (enforced in the view).
      - A02: Security misconfiguration
          * State-changing actions (scan) use POST + CSRF token, not GET.
      - A03/A05/A06: Injection / XSS / Insecure design
          * Breach descriptions come from external APIs (HIBP).
          * Rendered *without* |safe so Django auto-escapes HTML.
      - A09: Security logging & monitoring
          * Any sensitive logging happens in views/services, not in the template.
  {% endcomment %}

  <div class="card p-3 shadow-sm">
    {% comment %} Header row: identity label and action buttons (scan/back) {% endcomment %}
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0">{{ identity.address }}</h5>

      <div class="d-flex gap-2">
        {% comment %}
          "Scan Now" — triggers a rescan against HIBP.
          Security:
            - Uses POST (not GET) for state-changing behavior.
            - Protected with CSRF token (A02).
        {% endcomment %}
        <form method="post"
              action="{% url 'breaches:scan_identity' pk=identity.pk %}"
              class="m-0 d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-primary btn-sm">
            Scan Now
          </button>
        </form>

        {% comment %} Simple navigation back to the main page/dashboard {% endcomment %}
        <a class="btn btn-outline-secondary btn-sm" href="/">
          Back
        </a>
      </div>
    </div>

    {% comment %}
      Breach list:
        - Accordion of all BreachHit records linked to this identity.
        - If no hits, show a neutral “no known breaches” message.
    {% endcomment %}
    {% if hits %}
      <div class="accordion" id="breachAccordion">
        {% for h in hits %}
          <div class="accordion-item">
            {% comment %} Accordion header: breach title + optional domain {% endcomment %}
            <h2 class="accordion-header" id="head-{{ forloop.counter }}">
              <button class="accordion-button collapsed"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#col-{{ forloop.counter }}"
                      aria-expanded="false"
                      aria-controls="col-{{ forloop.counter }}">
                <strong class="me-2">
                  {{ h.title|default:h.breach_name }}
                </strong>
                {% if h.domain %}
                  <span class="text-muted">({{ h.domain }})</span>
                {% endif %}
              </button>
            </h2>

            {% comment %} Accordion body: dates, flags, data classes, and description {% endcomment %}
            <div id="col-{{ forloop.counter }}"
                 class="accordion-collapse collapse"
                 data-bs-parent="#breachAccordion"
                 aria-labelledby="head-{{ forloop.counter }}">
              <div class="accordion-body">

                {% comment %}
                  Date metadata row:
                    - Breach date
                    - Added date
                    - Modified date
                {% endcomment %}
                {% if h.occurred_on or h.added_on or h.modified_on %}
                  <div class="mb-2 small text-muted">
                    {% if h.occurred_on %}Breach date: {{ h.occurred_on }} · {% endif %}
                    {% if h.added_on %}Added: {{ h.added_on }} · {% endif %}
                    {% if h.modified_on %}Modified: {{ h.modified_on }}{% endif %}
                  </div>
                {% endif %}

                {% comment %}
                  Status and classification badges:
                    - PwnCount
                    - Verified / Unverified
                    - Sensitive / Spam list / Retired / Malware / Stealer log / Fabricated / Subscription free
                {% endcomment %}
                <div class="mb-2">
                  {% if h.pwn_count %}
                    <span class="badge text-bg-secondary me-1">
                      PwnCount: {{ h.pwn_count|intcomma }}
                    </span>
                  {% endif %}

                  {% if h.is_verified %}
                    <span class="badge text-bg-success me-1">Verified</span>
                  {% else %}
                    <span class="badge text-bg-warning text-dark me-1">Unverified</span>
                  {% endif %}

                  {% if h.is_sensitive %}
                    <span class="badge text-bg-danger me-1">Sensitive</span>
                  {% endif %}
                  {% if h.is_spam_list %}
                    <span class="badge text-bg-secondary me-1">Spam List</span>
                  {% endif %}
                  {% if h.is_retired %}
                    <span class="badge text-bg-dark me-1">Retired</span>
                  {% endif %}
                  {% if h.is_malware %}
                    <span class="badge text-bg-danger me-1">Malware</span>
                  {% endif %}
                  {% if h.is_stealer_log %}
                    <span class="badge text-bg-danger me-1">Stealer Log</span>
                  {% endif %}
                  {% if h.is_fabricated %}
                    <span class="badge text-bg-secondary me-1">Fabricated</span>
                  {% endif %}
                  {% if h.is_subscription_free %}
                    <span class="badge text-bg-info text-dark me-1">Free</span>
                  {% endif %}
                </div>

                {% comment %}
                  Data classes:
                    - Rendered as pill badges for readability.
                    - Values come from normalized HIBP data (not user input).
                {% endcomment %}
                {% if h.data_classes %}
                  <div class="mb-2">
                    <span class="badge text-bg-info text-dark">Data Classes</span>
                    <div class="mt-1">
                      {% for c in h.data_classes %}
                        <span class="badge text-bg-light border me-1 mb-1">
                          {{ c }}
                        </span>
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}

                {% comment %}
                  Breach description:
                    - This text originates from an external API (HIBP).
                    - To avoid XSS (OWASP A03/A05/A06), we:
                        * Do NOT use |safe here.
                        * Rely on Django auto-escaping, and optionally
                          use |linebreaks to preserve paragraph breaks.
                {% endcomment %}
                {% if h.description %}
                  <div class="text-body-secondary">
                    {{ h.description|linebreaks }}
                  </div>
                {% endif %}

              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      {% comment %} Fallback when there are no stored breach hits for this identity {% endcomment %}
      <div class="alert alert-secondary mb-0">
        No known breaches stored.
      </div>
    {% endif %}
  </div>

{% endblock %}
